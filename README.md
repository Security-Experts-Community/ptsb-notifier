# Telegram-бот для отправки уведомлений о новых сработках в системе Positive Technologies Sandbox

## Содержание
- [Описание проекта](#описание-проекта)
- [Требования](#требования)
- [Установка приложения](#установка-приложения)
- [Удаление приложения](#удаление-приложения)
- [Изменение конфигурации приложения](#изменение-конфигурации-приложения)
- [Обновление приложения](#обновление-приложения)
- [Лицензия](#лицензия)
- [Отказ от обязательств](#отказ-от-обязательств)
- [Авторы](#авторы)
- [Контакты](#контакты)

## Описание проекта
Данная утилита предназначена для отправки уведомлений о новых подозрительных вердиктах в системе Positive Technologies Sandbox через Telegram-бота.

Основная интеграция этого приложения и ptsb выполняется по протоколу `syslog` (на транспортном уровне используется `tcp`). Приложение прослушивает весь входящий трафик на специализованном порту, отсеивает не подходящие syslog-события и выбирает из них только те, которые содержат подстроку `- scan_machine.final_result -`, т.е. событие означающее вынесение вердикта по отдельно взятому заданию. Далее происходит филтрация по `тело сообщения` -> `resust` -> `verdict` -> `threat_level` и если уровень угрозы удовлетворяет тому, что настроил для себя пользователь - информация об этом задании будет отправлена через Telegram-бота

## Требования
- Приложение запускается внутри `docker`-контейнера. Для корректной работы требуется установленное ПО `docker` и входящий в него модуль `compose`.
- Наличие возможности транслировать syslog сообщения от ptsb до хоста, на котором будет запущено приложение. Встроенный в проект сервер работает по транспортному протоколу `tcp`, приём `udp` сообщений от ptsb не тестировался. <br>
***Примечание***: syslog сообщения могут транслироваться в приложение и после различных балансеров, если такие используются в Вашей инфрастуктуре.
- Доступ до `https://api.telegram.org` от хоста, на котором будет развёрнуто приложение, чтобы осуществлять доступ к Public API бота.
- Аккаунт в Telegram.

## Установка приложения

### 1. Создание бота в Telegram
Для того, чтобы Telegram-бот мог отправлять Вам уведомления, его необходимо создать и получить `токен` доступа к нему. Через этот `токен` бот будет осуществлять взаимодействие с публичным API Telegram.

1. Перейти в диалог с [BotFather](https://t.me/BotFather) - официльным Telegram-ботом для создания новых ботов.
2. Отправить ему команду `/start`
3. Из предложенного списка выбрать `/newbot` и нажать ЛКМ
4. Бот запросит имя для создамаемого Вами бота. Здесь можно ввести любое название в рамках цензуры. Оно не обязательно должно быть уникальным, это будет то имя, которое отображается как имя Отправителя в Telegram.
5. Бот запросит ввести `username` (ссылку) для создаваемого бота. Она обязательно должна быть уникальной, а также заканчиваться на `bot`. Если введенное значение не удовлетворит условиям, BotFater перезапросит ввод `username` для Вашего бота.
6. В случае, если всё было указано верно, в ответ на `username` BotFather вернёт:
    - Ссылку на Вашего бота. Она будет выглядеть как `t.me/<username>`. Рекомендуется перейти по ней и нажать "Запустить", чтобы бот отобразился в Ваших диалогах.
    - Токен доступа к Вашему боту. Его можно скопировать нажатием на текст токена. Токен понадобится в дальнейшем при настройке приложения. <br>
    ***Внимание!*** Никому не сообщайте токен от Вашего бота ни при каких условиях. Если Вам кажется, что токен скомпрометирован - удалите бота через BotFather и создайте нового.

На этом создание бота завершено. При желании Вы можете изменить боту имя или установить аватарку.

---
### 2. Настройка чата в Telegram
На этом шаге необходимо получить `Telegram ID` беседы, куда бот будет отправлять сообщения.

#### Если бот должен отправлять сообщения только Вам
Если Вы хотите, чтобы бот уведомлял только Вас через личные сообщения в Telegram (т.е. не состоял в какой-то беседе), то для настройки:
1. Перейдите в бота [Get My ID](https://t.me/getmyid_bot) для получения Вашего ID.
2. Отправьте боту команду `/start`. Бот пришлет в ответ сообщение, в котором будет указано `Your user ID`. Скопируйте или запомните это числовое значение

На этом работа с `Telegram ID` завершена.

---
#### Если бот должен отправлять сообщения в беседу
Если Вы хотите, чтобы бот уведомлял несколько людей, которые состоят в Telegram-беседе (например весь департамент ИБ) то для настройки:
1. Создайте `группу` в Telegram. Название и аватарка могут быть любыми. Приглашать сразу никого не требуется.
2. Перейдите в бота [Get My ID](https://t.me/getmyid_bot) для получения `Telegram ID` группы.
3. Нажмите на профиль бота вверху. Откроется профиль взаимодействия с ботом.
4. В профиле бота выберите `Добавить в группу`. В списке выберите группу, созаднную на шаге №1.
5. После добавления бота в группу, он должен прислать сообщение содержащее `Current chat ID` (может содержать минус впереди). Если этого не произошло, то отправьте в чат команду `/start@getmyid_bot`. 
6. Скопируйте или запомните числовое значение `Current chat ID` (включая минус, если есть).
7. Удалите бота `Get My ID` из Вашей группы через меню управления группой.
8. Перейдите в созданного Вами ранее бота. 
9. Аналогичным образом добавьте Вашего бота, которого Вы создали для отправки уведомлений, в созданнную группу на шаге №1.

На этом работа с `Telegram ID` завершена.

***Примечание***: для настройки *безопасности* в группе рекомендуется:
- `Тип группы` - установить как *Частная группа*. Новых людей в беседу приглашать лично.
- `Сохранение контента` - запретить копирование (пересылку).
- `Разрешения` - выключить **все** разрешения у пользователей.
- `Администраторы` - добавить созданного пользователя как *Администратора*. Это позволит боту отправлять сообщения, даже если всем пользователям в группе отправлять сообщения запрещено. При этом, все *Возможности администратора* у бота могут быть выключены.

---
### 3. Скачивание проекта
1. Для скачивания исходного кода зайдите на Linux-хост.
2. Скачайте исходный код при помощи `git`:
    ```bash
    git clone https://github.com/kaifuss/ptsb-notifier.git
    ```
    Или как ZIP-архив по ссылке:
    ```bash
    https://github.com/kaifuss/ptsb-notifier/archive/refs/heads/main.zip
    ```

---
### 4. Установка и настройка
Уставнока должна выполняться из под пользователя root (не sudo).

***Примечание***: по умолчанию приложение будет слушать входящий syslog-трафик от ptsb на локальном порту `1468` хоста, куда устанавливается приложение. Если на хосте, куда Вы ставите приложение порт `1468` уже занят - Вы можете изменить его вручную. Для этого откройте в текстовом редакторе файл `builder/docker-compose.yaml` и в разделе `ports` измените `1468:514` на `<требуемый порт>:514`. Порт `514` является внутренним в docker-контейнере и его менять не нужно. 

1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-notifier
    ```
2. Сделайте файл `install.sh` исполняемым:
    ```bash
    chmod +x install.sh
    ```
3. Запустите установку приложения через `install.sh`, находясь всё в той же директории:
    ```bash
    ./install.sh
    ```
    Скрипт начнет запрашивать параметры, согласно которым будет настроено приложение. Если не вводить ничего и нажать `Enter` - будет сохранено значение по умолчанию.
4. Для настройки перехода к страницам заданий, в которых обнаружены сработки, необходимо ввести адрес веб-интерфейса, по которому доступен ptsb. Если используется FQDN - вводите FQDN. Если используется отказоустойчивый кластер - вводите адрес отказоустойчивого кластера.
    ```bash
    Введите значение для PTSB_MAIN_WEB (текущее: '')
    ```
5. Для фильтрации того, какого уровня вердикты будут Вам отправляться используется параметр `THREAT_FILTER_MODE`. По умолчанию он равен `ALL`. Ниже приведено соответствие между значениями этого параметра и тем, какие уведомления будут отправляться:
    - `ALL`: отправляются уведомления о заданиях с вердиктами `Результат неизвестен` (серый цвет), `Потенциально опасное ПО` (желтый цвет) и `Опасное ПО` (красный цвет).

    - `UNWANTED`: отправляются уведомления о заданиях с вердиктами `Потенциально опасное ПО` (желтый цвет) и `Опасное ПО` (красный цвет).
    
    - `DANGEROUS`: отправляются уведомления о заданиях с вердиктом  `Опасное ПО` (красный цвет).<br>
    
    Ввод выглядит следующим образом:
    ```bash
    Введите значение для THREAT_FILTER_MODE (текущее: ALL): UNWANTED
    ```
    ***Примечание***: Ввод регистрозависим, необходимо вводить значение заглавными буквами.
6. Для настройки Telegram-бота необходимо ввести токен, который был получен на предыдущих шагах. Достаточно просто скопировать и вставить токен в запрашиваемой строке:
    ```bash
    Введите значение для TG_BOT_TOKEN (текущее: ''):
    ```
7. Для настройки чата, куда бот будет отправлять уведомления также навдо ввети `Telegram ID` чата, который был получен ранее (Ваш линый или группы):
    ```bash
    Введите значение для TG_CHAT_ID (текущее: ''):
    ```
    ***Примечание***: В случе, если `TG_CHAT_ID` содержит знак минус, необходимо вставить значение с минусом.
8. Syslog-демон на ptsb отпавляет syslog-сообщения с указанием времени в часовом пояле UTC+0. Если Вы живете в МСК часовом поясе, то Ваше локальное время смещено на +3 часа от UTC. Если Вы живете в МСК-1 часом поясле, то Ваше локальное время смещено на +2 часа от UTC. Для того, чтобы корректно отображать время получения вердикта по заданию, необходимо ввести смещение по времени относительно UTC:
    ```bash
    Введите значение для UTC_CUSTOM_OFFSET (текущее: 3):
    ```
    ***Примечание***: также поддерживается ввод отрицательного числа, например `-1`. 
9. После ввода последнего параметра начнется сборка docker-образа и установка приложения. По завершении установки выведутся сообщения:
    ```bash
     ✔ Service ptsb-notifier    Built
     ✔ Container ptsb-notifier  Started
    ```

Установка завершена. Вы можете выйти из пользователя root.

---
### 5. Настройка PT Sandbox
Перейдите в веб-интерфейс системы ptsb -> вкладка `Система` -> раздел `Основаные параметры` -> блок настроек `Отправка сообщений в системный журнал по протоколу syslog`.
1. Включите отпраку сообщений по протоколу syslog переключателем.
2. В качестве адреса `Сервера системного журнала` укажите адрес хоста, на котором было развернуто приложение.
3. В качестве порта укажите `1468`, если не изменяли порт по умолчанию. Если изменяли, укажите Ваш порт.
4. Протоколом выберите `TCP`.
5. Нажмите `Сохранить` в нижней части экрана для применения изменений. Подождите несколько минут, пока изменения применятся.

***Примечание***: Если syslog-трафик от ptsb будет поступать в приложение от некого balancer сервиса - произведите его настройку аналогичным образом.

На этом настройка источника оптавки syslog-сообщения завершена. Для проверки работоспособности приложения отправьте на проверку любой файл, хэш которого у Вас добавлен в черный список.


## Удаление приложения
Удаление приложение необходимо производить также от имени супер пользователя root:
1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-notifier
    ```
2. Сделайте файл `uninstall.sh` исполняемым:
    ```bash
    chmod +x uninstall.sh
    ```
3. Запустите удаление приложения через `uninstall.sh`, находясь всё в той же директории:
    ```bash
    ./uninstall.sh
    ```
По окончании удаления скрипт выведет информацию о том, что удаление docker-контейнера и образа docker-контейнера завершено.


## Изменение конфигурации приложения
Изменение конфигурации может потебоваться, если Вы хотите поменять какие-то параметры. Например, токен Telegram-бота в связи с созданием нового бота или Telegram ID чата, куда бот должен отправлять уведомления. При этом, переустановки не происходит.

Изменение параметров производится от имени супер пользователя root:
1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-notifier
    ```
2. Запустите установку через `install.sh`, находясь всё в той же директории:
    ```bash
    ./install.sh
    ```
3. Введите новые значения для тех параметров, которые требуется изменить. Если какой-то параметр менять не нужно, то просто нажмите `Enter` и значение останется равным тому, что сохранено в скобках. 
4. Скрипт укажет, что образ контейнера уже найден. Введите `update` для переконфигурации основных параметров приложения:
    ```bash
    Образ 'ptsb-notifier' уже существует. Вы хотите обновить образ или пересобрать его заново? (update/rebuild): update
    ```
    
    По завершении переконфигурации выведутся сообщения:
    ```bash
     ✔ Service ptsb-notifier    Built
     ✔ Container ptsb-notifier  Started
    ```

Переконифгурация приложения завершена.


## Обновление приложения
Обновление может потребоваться, если вышла новая версия. В этом случае происходит пересборка приложения. В случае скачивания новой версии через `git clone` может перезаписаться файл со старыми параметрами приложения. Перед установкой новой версии рекомендуется выписать старые параметры, например, через `cat config/default.env`.

Обновление производится от имени супер пользователя root:
1. Перейдите в корневую директорию скачанного проекта:
    ```bash
    cd ptsb-notifier
    ```
2. Запустите установку через `install.sh`, находясь всё в той же директории:
    ```bash
    ./install.sh
    ```
3. Если какой-то параметр менять не нужно, то просто нажмите `Enter` и значение останется равным тому, что сохранено в скобках. 
4. Скрипт укажет, что образ контейнера уже найден. Введите `rebuild` для переконфигурации основных параметров приложения:
    ```bash
    Образ 'ptsb-notifier' уже существует. Вы хотите обновить образ или пересобрать его заново? (update/rebuild): rebuild
    ```
    
    По завершении пересборки приложения выведутся сообщения:
    ```bash
    ✔ Network builder_default  Created
    ✔ Container ptsb-notifier  Started
    ```

Обновление приложения завершено.

## Лицензия
Shield: [![CC BY-NC 4.0][cc-by-nc-shield]][cc-by-nc]

This work is licensed under a
[Creative Commons Attribution-NonCommercial 4.0 International License][cc-by-nc].

[![CC BY-NC 4.0][cc-by-nc-image]][cc-by-nc]

[cc-by-nc]: https://creativecommons.org/licenses/by-nc/4.0/
[cc-by-nc-image]: https://licensebuttons.net/l/by-nc/4.0/88x31.png
[cc-by-nc-shield]: https://img.shields.io/badge/License-CC%20BY--NC%204.0-lightgrey.svg

p.s.
If we meet some day, and you think this stuff is worth it, you can buy me a beer in return.


## Отказ от обязательств
Автор не имеет отношения к компании Positive Technologies и не является её сотрудником. Также автор не несет ответственности за любые последствия от использования приложения на реальных инсталляциях. Ответственность лежит исключительно на конечном пользователе.

## Авторы
Кирилл Красновский - Full-fledged work on the project - [Github](https://github.com/kaifuss) <br>

Отдельно выражаю слова благодарности Роману Б. за помощь и поддержку на протяжении всей разработки проекта - [Github](https://github.com/rberzh)

## Контакты
Для связи с автором проекта обращаться в tg: [@corgi_llama](https://t.me/corgi_llama)